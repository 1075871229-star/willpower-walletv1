<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®šåŠ›å­˜é’±ç½ - è”ç½‘ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS æ ·å¼éƒ¨åˆ† --- */
        :root {
            --primary-green: #2ecc71;
            --dark-green: #27ae60;
            --bg-color: #f4f7f6;
            --text-dark: #2c3e50;
            --text-light: #95a5a6;
            --white: #ffffff;
            --danger: #e74c3c;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-dark); padding-bottom: 80px; }

        .hidden { display: none !important; }
        .btn { background-color: var(--primary-green); color: white; border: none; padding: 12px 24px; border-radius: 50px; font-size: 16px; font-weight: bold; width: 100%; cursor: pointer; transition: transform 0.1s; margin-top: 10px; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-green); color: var(--primary-green); }
        .card { background: var(--white); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 16px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0 16px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; background: #fafafa; }
        
        /* ç™»å½•é¡µæ ·å¼ */
        #section-auth { padding: 40px 24px; min-height: 100vh; background: white; display: flex; flex-direction: column; justify-content: center; }
        .auth-toggle { text-align: center; margin-top: 20px; font-size: 14px; color: #666; cursor: pointer; text-decoration: underline; }

        /* ä¸»ç•Œé¢æ ·å¼ */
        .hero-card { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border-radius: 20px; padding: 25px; margin: 20px; box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3); }
        .hero-stats { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .stat-item .value { font-size: 28px; font-weight: 800; margin-top: 5px; }
        .insight-text { background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px; text-align: center; }
        .feed-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 70px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--text-light); width: 20%; cursor: pointer; }
        .nav-item.active { color: var(--primary-green); }
        .fab-container { position: relative; top: -25px; }
        .fab-btn { width: 60px; height: 60px; background: var(--primary-green); border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; cursor: pointer; }
        
        /* æ’è¡Œæ¦œæ ·å¼ */
        .rank-item { display: flex; align-items: center; padding: 15px; background: white; border-radius: 12px; margin-bottom: 10px; box-shadow: var(--shadow); }
        .rank-num { font-size: 18px; font-weight: bold; width: 30px; color: var(--text-light); }
        .is-me { border: 2px solid var(--primary-green); background: #e8f5e9; }
        
        /* æ¨¡æ€æ¡† */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 24px; animation: slideUp 0.3s ease; max-height: 80vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .food-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .food-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 12px; cursor: pointer; }
        .food-item.selected { border-color: var(--primary-green); background: #e8f5e9; }
        .food-emoji { font-size: 24px; margin-bottom: 5px; }
        .food-name { font-size: 12px; text-align: center; }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
<body>

    <div id="section-auth">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="color: var(--primary-green); margin-bottom: 10px;">ğŸ¥¦ å®šåŠ›å­˜é’±ç½</h1>
            <p style="color: #666;">äº‘ç«¯åŒæ­¥ Â· çœŸå®ç¤¾äº¤</p>
        </div>
        
        <div class="card">
            <h3 id="auth-title">ç™»å½•è´¦å·</h3>
            <input type="email" id="auth-email" placeholder="é‚®ç®±åœ°å€ (ç”¨äºæ‰¾å›è´¦å·)">
            <input type="password" id="auth-password" placeholder="è®¾ç½®å¯†ç  (è‡³å°‘6ä½)">
            <button class="btn" id="btn-auth-action" onclick="handleAuth()">ç™»å½• / æ³¨å†Œ</button>
            <div id="auth-msg" style="color: red; font-size: 12px; margin-top: 10px; text-align: center;"></div>
        </div>
        <div class="auth-toggle" onclick="toggleAuthMode()">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</div>
    </div>

    <div id="section-onboarding" class="hidden" style="padding: 40px 24px; min-height: 100vh; background: white;">
        <div class="card">
            <h3>å®Œå–„æ‚¨çš„æ¡£æ¡ˆ</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">*è¿™å†³å®šäº†çƒ­é‡è®¡ç®—çš„å‡†ç¡®æ€§</p>
            <label>æ˜µç§°</label><input type="text" id="ob-name">
            <label>æ‰‹æœºå· (ä½œä¸ºç¤¾ç¾¤ID)</label><input type="tel" id="ob-phone">
            <label>èº«é«˜ (cm)</label><input type="number" id="ob-height">
            <label>ä½“é‡ (kg)</label><input type="number" id="ob-weight">
            <label>å¹´é¾„</label><input type="number" id="ob-age">
            <button class="btn" onclick="saveUserProfile()">å¼€å§‹æ—…ç¨‹</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="tab-home" class="tab-content">
            <div style="padding: 20px 20px 0;">
                <div style="font-size: 14px; color: #777;">Hi, <span id="display-name">...</span></div>
                <div style="font-size: 20px; font-weight: bold;">ä»Šå¤©ä¹Ÿæ˜¯æ„å¿—åŠ›çˆ†æ£šçš„ä¸€å¤©ï¼</div>
            </div>
            <div class="hero-card">
                <div class="hero-stats">
                    <div class="stat-item">
                        <h3>ç´¯è®¡çœä¸‹</h3>
                        <div class="value">Â¥<span id="display-money">0</span></div>
                    </div>
                    <div class="stat-item" style="text-align: right;">
                        <h3>å°‘æ‘„å…¥çƒ­é‡</h3>
                        <div class="value" style="color: #ffeb3b;"><span id="display-cal">0</span> kcal</div>
                    </div>
                </div>
                <div class="insight-text">ğŸƒ ç›¸å½“äºæ‚¨æ…¢è·‘äº† <span id="display-jogging">0</span> åˆ†é’Ÿ</div>
            </div>
            <div style="padding: 0 20px;">
                <h4 style="margin: 0 0 15px;">è¿‘æœŸè®°å½• (å®æ—¶äº‘åŒæ­¥)</h4>
                <div id="records-container">
                    <div style="text-align: center; color: #aaa; margin-top: 20px; font-size: 13px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <div id="tab-community" class="tab-content hidden" style="padding: 20px;">
            <h2 style="margin-top: 0;">ğŸ”¥ çœŸå®ç¤¾ç¾¤æ’è¡Œæ¦œ</h2>
            <div class="card" style="background: #e3f2fd; border: 1px solid #90caf9;">
                <p style="font-size: 12px; margin:0;">è¿™æ˜¯çœŸå®å­˜åœ¨çš„ç”¨æˆ·æ•°æ®ã€‚é‚€è¯·æœ‹å‹æ³¨å†Œï¼Œä»–ä»¬å°±ä¼šå‡ºç°åœ¨è¿™é‡Œï¼</p>
            </div>
            <button class="btn" onclick="refreshLeaderboard()">åˆ·æ–°æ’è¡Œæ¦œ</button>
            <div id="leaderboard-list" style="margin-top: 20px;"></div>
        </div>

        <div id="tab-stats" class="tab-content hidden" style="padding: 20px;">
            <h2>è´¢å¯Œç§¯ç´¯è¶‹åŠ¿</h2>
            <div class="card" style="height: 300px;">
                <canvas id="moneyChart"></canvas>
            </div>
        </div>

        <div id="tab-profile" class="tab-content hidden" style="padding: 20px;">
            <h2>æˆ‘çš„æ¡£æ¡ˆ</h2>
            <div class="card">
                <p><strong>è´¦å·:</strong> <span id="p-email"></span></p>
                <p><strong>æ˜µç§°:</strong> <span id="p-name"></span></p>
                <p><strong>èº«ä½“æ•°æ®:</strong> <span id="p-body"></span></p>
            </div>
            <button class="btn" style="background: #e74c3c;" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home', this)"><span>ğŸ  é¦–é¡µ</span></div>
            <div class="nav-item" onclick="switchTab('community', this)"><span>ğŸ† ç¤¾ç¾¤</span></div>
            <div class="fab-container"><div class="fab-btn" onclick="openAddModal()">+</div></div>
            <div class="nav-item" onclick="switchTab('stats', this)"><span>ğŸ“ˆ ç»Ÿè®¡</span></div>
            <div class="nav-item" onclick="switchTab('profile', this)"><span>ğŸ‘¤ æˆ‘çš„</span></div>
        </div>
    </div>

    <div id="add-modal" class="modal hidden">
        <div class="modal-content">
            <h3>åˆšæ‰å¿ä½äº†ä»€ä¹ˆï¼Ÿ</h3>
            <div class="food-grid">
                <div class="food-item" onclick="selectFood('å¥¶èŒ¶', 500, 25)">
                    <div class="food-emoji">ğŸ§‹</div><div class="food-name">å¥¶èŒ¶</div>
                </div>
                <div class="food-item" onclick="selectFood('ç‚¸é¸¡', 600, 35)">
                    <div class="food-emoji">ğŸ—</div><div class="food-name">ç‚¸é¸¡</div>
                </div>
                <div class="food-item" onclick="selectFood('è›‹ç³•', 450, 30)">
                    <div class="food-emoji">ğŸ°</div><div class="food-name">è›‹ç³•</div>
                </div>
                <div class="food-item" onclick="selectFood('çƒ§çƒ¤', 800, 80)">
                    <div class="food-emoji">ğŸ¢</div><div class="food-name">çƒ§çƒ¤</div>
                </div>
            </div>
            <div id="selected-info" class="hidden">
                <label>ç¡®è®¤çœä¸‹çš„é’± (Â¥)</label>
                <input type="number" id="input-price">
                <button class="btn" onclick="confirmRecord()">ç¡®è®¤è®°å½•</button>
            </div>
            <div style="text-align: center; margin-top: 15px;" onclick="document.getElementById('add-modal').classList.add('hidden')">å–æ¶ˆ</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, orderBy, updateDoc, increment, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // âœ… è¿™é‡Œæ˜¯ä½ çš„æœ€æ–°é…ç½® (willpower-wallet)
        const firebaseConfig = {
            apiKey: "AIzaSyDRRIkrHQ4o4Dds4wMxL86MarES7-jLCEw",
            authDomain: "willpower-wallet.firebaseapp.com",
            projectId: "willpower-wallet",
            storageBucket: "willpower-wallet.firebasestorage.app",
            messagingSenderId: "219930043602",
            appId: "1:219930043602:web:2508223f027ace3fa2390b"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUserData = null;
        let isRegistering = false;
        let currentSelectedFood = null;

        // --- è®¤è¯é€»è¾‘ ---
        window.toggleAuthMode = () => {
            isRegistering = !isRegistering;
            document.querySelector('#auth-title').innerText = isRegistering ? "æ³¨å†Œæ–°è´¦å·" : "ç™»å½•è´¦å·";
            document.querySelector('.auth-toggle').innerText = isRegistering ? "å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•" : "æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const msg = document.getElementById('auth-msg');
            
            if(!email || !password) return msg.innerText = "è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ";

            try {
                if (isRegistering) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                msg.innerText = error.message.replace("Firebase: ", "");
            }
        };

        window.handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('section-auth').classList.add('hidden');
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    showDashboard();
                } else {
                    document.getElementById('section-onboarding').classList.remove('hidden');
                }
            } else {
                document.getElementById('section-auth').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('section-onboarding').classList.add('hidden');
            }
        });

        // --- ä¸šåŠ¡é€»è¾‘ ---
        window.saveUserProfile = async () => {
            const user = auth.currentUser;
            const profile = {
                uid: user.uid,
                email: user.email,
                name: document.getElementById('ob-name').value,
                phone: document.getElementById('ob-phone').value,
                height: Number(document.getElementById('ob-height').value),
                weight: Number(document.getElementById('ob-weight').value),
                age: Number(document.getElementById('ob-age').value),
                totalMoney: 0,
                totalCalories: 0
            };

            await setDoc(doc(db, "users", user.uid), profile);
            currentUserData = profile;
            document.getElementById('section-onboarding').classList.add('hidden');
            showDashboard();
        };

        function showDashboard() {
            document.getElementById('app-container').classList.remove('hidden');
            updateUI();
            loadRecords();
            refreshLeaderboard();
        }

        function updateUI() {
            document.getElementById('display-name').innerText = currentUserData.name;
            document.getElementById('display-money').innerText = currentUserData.totalMoney;
            document.getElementById('display-cal').innerText = currentUserData.totalCalories;
            const calPerMin = currentUserData.weight * 0.115;
            const savedMinutes = Math.round(currentUserData.totalCalories / (calPerMin || 1));
            document.getElementById('display-jogging').innerText = savedMinutes;
            document.getElementById('p-email').innerText = currentUserData.email;
            document.getElementById('p-name').innerText = currentUserData.name;
            document.getElementById('p-body').innerText = `${currentUserData.height}cm / ${currentUserData.weight}kg`;
        }

        async function loadRecords() {
            const user = auth.currentUser;
            const q = query(collection(db, "records"), where("uid", "==", user.uid), orderBy("timestamp", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            const container = document.getElementById('records-container');
            container.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'feed-item';
                div.innerHTML = `<div><strong>${data.food}</strong> <span style="font-size:12px;color:#999">${new Date(data.timestamp.toDate()).toLocaleTimeString()}</span></div><div style="text-align:right"><div style="color:var(--dark-green);font-weight:bold">+Â¥${data.price}</div><div style="font-size:12px;color:#f39c12">-${data.calories} kcal</div></div>`;
                container.appendChild(div);
            });
        }

        window.selectFood = (name, cal, defaultPrice) => {
            document.querySelectorAll('.food-item').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            currentSelectedFood = { name, cal };
            document.getElementById('input-price').value = defaultPrice;
            document.getElementById('selected-info').classList.remove('hidden');
        };

        window.confirmRecord = async () => {
            const price = Number(document.getElementById('input-price').value);
            const user = auth.currentUser;
            await addDoc(collection(db, "records"), { uid: user.uid, food: currentSelectedFood.name, calories: currentSelectedFood.cal, price: price, timestamp: new Date() });
            const userRef = doc(db, "users", user.uid);
            await updateDoc(userRef, { totalMoney: increment(price), totalCalories: increment(currentSelectedFood.cal) });
            currentUserData.totalMoney += price;
            currentUserData.totalCalories += currentSelectedFood.cal;
            updateUI();
            loadRecords();
            document.getElementById('add-modal').classList.add('hidden');
            alert(`å·²åŒæ­¥åˆ°äº‘ç«¯ï¼`);
        };

        window.refreshLeaderboard = async () => {
            const q = query(collection(db, "users"), orderBy("totalMoney", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            let rank = 1;
            querySnapshot.forEach((doc) => {
                const u = doc.data();
                const isMe = u.uid === auth.currentUser.uid;
                const div = document.createElement('div');
                div.className = `rank-item ${isMe ? 'is-me' : ''}`;
                div.innerHTML = `<div class="rank-num">${rank++}</div><div style="flex:1"><div style="font-weight:bold">${u.name} ${isMe ? '(æˆ‘)' : ''}</div><div style="font-size:12px;color:#999">ID: ${u.phone || '***'}</div></div><div style="font-weight:bold;color:var(--primary-green)">Â¥${u.totalMoney}</div>`;
                list.appendChild(div);
            });
        };

        window.openAddModal = () => { document.getElementById('add-modal').classList.remove('hidden'); document.getElementById('selected-info').classList.add('hidden'); };
        window.switchTab = (tabName, el) => { document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden')); document.getElementById('tab-' + tabName).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active')); el.classList.add('active'); if(tabName === 'community') refreshLeaderboard(); };

        const ctx = document.getElementById('moneyChart').getContext('2d');
        new Chart(ctx, { type: 'line', data: { labels: ['Start', 'Now'], datasets: [{ label: 'çœé’±è¶‹åŠ¿', data: [0, 10], borderColor: '#2ecc71', tension: 0.4 }] } });
    </script>
</body>
</html>